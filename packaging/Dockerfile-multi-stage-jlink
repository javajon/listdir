# Because JLink provides binaries for the final container, Linux flavors in both stages must match
# Java 13+ will be supported in Gradle 6, this project uses Gradle 5x

## Stage 1 : Gradle build produces the application executable jar and custom JRE
FROM openjdk:12-jdk-alpine AS jlinker

# Copy local source
COPY . /home/gradle/src
WORKDIR /home/gradle/src

# Build jar and use JLink to create new distilled JRE
RUN ./gradlew jar jlink --build-file build-jlink.gradle


## Stage 2 : Final image populated with custom JRE and application executable jar
FROM alpine:latest

ENV JAVA_MINIMAL=/opt/jre
ENV PATH="$PATH:$JAVA_MINIMAL/bin"

# Copy distilled JRE generated by JLink
COPY --from=jlinker /home/gradle/src/build/image "$JAVA_MINIMAL"/

# Copy application as executable jar
COPY --from=jlinker /home/gradle/src/build/libs/src-0.1.0.jar listdir.jar

# Run application using executable jar application 
CMD ["java", "-jar", "listdir.jar"]
